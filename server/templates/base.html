<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>CAS2029 - Home</title>

  <!-- Bootstrap core CSS -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.css" rel="stylesheet">
  <!-- Tempus dominus CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet">
    <!-- Bootstrap core JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.js"></script>
   <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css">
  <!-- Tempus dominus JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js"></script>

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark static-top">
    <div class="container">
      <a class="navbar-brand" href="#">Welcome to CAS29!</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <a class="nav-link" href="{{ url_for('home') }}">Home
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('about') }}">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('test') }}">Test</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('contact') }}">Contact</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>




#{% block content %}{% endblock %}




  
  <script>
  // update form values from sliders
  function updateRadiusInput(val) {
          document.getElementById('radius').value=val; 
        }
        
    function updateMarginInput(val) {
          document.getElementById('margin').value=val; 
        }
  </script>
  
  
    <script>
        function apiFunction() {
        var lt = document.getElementById('lat').value
        var ln = document.getElementById('lon').value
        var rd = document.getElementById('radius').value
        var mr = document.getElementById('margin').value

        var apiURL = window.location.href+"api?LAT="+lt+"&LON="+ln+"&RADIUS="+rd+"&TIME="+getMsSinceMidnight(document.getElementById("dtp").value)+"&MARGIN="+mr;
          document.getElementById("api_req").innerHTML = apiURL;
        $( "#api_resp" ).load(apiURL);  
        
        
        
        fetch(apiURL)
        .then(res => res.json())
        .then((out) => {
           // console.log('Output: ', out);
            //console.log(out[1]);
            // add things to interpreted output
            
            document.getElementById("r1").innerHTML = "<h4>Historical geo-temporal risks for pedestrian crashes in your area at "+document.getElementById("dtp").value+" (+/-)"+mr+" min:</h4>";
            $("#r1").append("Number of pedestrians struck on road: "+ out[0].Struck_pedestrian_On_Road);
            $("#r1").append("<br>Number of pedestrians struck off road: "+ out[0].Struck_pedestrian_Off_Road);
            $("#r1").append("<br>Number of fatal incidents: "+ out[0].Fatal);
            $("#r1").append("<br>Number of non-fatal injuries: "+ out[0].Injury);
            $("#r1").append("<br>Number of incidents with property damage only: "+ out[0].Property_Damage_Only);
            $("#r1").append("<br>Collisions with parked vehicle: "+ out[0].Collision_with_parked_vehicle);
            $("#r1").append("<br>Side-swipes in opposite directions: "+ out[0].Opposite_direction_side_swipe);
            $("#r1").append("<br>Number vehicle-to-vehicle incidents: "+ out[0].Other__Vehicle_to_Vehicle);            
            $("#r1").append("<br>Number of incidents with right-angle collision: "+ out[0].Right_angle_collision);
            $("#r1").append("<br>Number of incidents involing right-turn into oncoming traffic: "+ out[0].Right_turn_into_oncoming_vehicle);
            
             // try interpret summary for cyclists if it exists
      
              try {
              //
              var test_case = out[1].Injury;
              $("#r1").append("<hr><h4>Historical geo-temporal risks for cyclist crashes in your area at "+document.getElementById("dtp").value+" (+/-)"+mr+" min:</h4>");
              $("#r1").append("Number of injuries: "+ out[1].Injury);
              $("#r1").append("<br>Number of fatalities: "+ out[1].Fatal);
              $("#r1").append("<br>Number of incidents involving property damage only: "+ out[1].Property_Damage_Only);
              
              
              $("#r1").append("<br>Head-on collisions: "+ out[1].Head_on_collision);
              
              $("#r1").append("<br>Rear-end collisions: "+ out[1].Rear_end_collision);
              $("#r1").append("<br>Right-angle collisions: "+ out[1].Right_angle_collision);
              
              $("#r1").append("<br>Right turns into oncoming vehicle: "+ out[1].Right_turn_into_oncoming_vehicle);
              $("#r1").append("<br>Same direction side-swipes: "+ out[1].Same_direction_side_swipe);
              
              //"Collision_while_one_vehicle_reversing":0,
              //"Collision_with_parked_vehicle":0,
              //"Fall_from_moving_vehicle_On_Road":0,
      
              //"Opposite_direction_side_swipe":0,
              //"Other__Vehicle_to_Vehicle":0,
              //"Other___Single_Vehicle_On_Road":0,
              //"Overturned_Off_Road":0,
              //"Overturned_On_Road":0,
              
              //"Struck_animal_not_ridden_On_Road":0,
              //"Struck_object_Off_Road":0,
              //"Struck_object__On_Road":0,
              //"Struck_pedestrian_Off_Road":0,
              //"Struck_pedestrian_On_Road":0}
              
              
              }
              catch {
              console.log("There is something wrong with data on cyclist crashes...");
              //
              }
            
            
            $("#r1").append("<hr><h4>Current weather conditions:</h4><br>Current temperature: "+ out[2].temperature + " C");
            $("#r1").append("<br>Feels like: "+ out[2].apparent_temperature + " C");
            $("#r1").append("<br>Rain since 9 am: "+ out[2].rainsince9am + " mm");
            $("#r1").append("<br>Wind speed: "+ out[2].wind_spd_kmh + " km/h");
            $("#r1").append("<br>Wind direction: "+ out[2].wind_dir + " ");
            $("#r1").append("<br>Wind gusts: "+ out[2].wind_gust_kmh + " km/h");
            
            $("#r1").append("<br>Atmospheric pressure: "+ out[2].press_qnh + " hPa");
            
            $("#r1").append("<br>Relative humidity: "+ out[2].rel_humidity + " %");
            $("#r1").append("<br>Dew point: "+ out[2].dew_point + " C");
            $("#r1").append("<br>Observation date/time: "+ out[2].update_datetime + " ");
            
            
  

            
        }).catch(err => console.error(err));

            
        }   
    </script>
  
  
  <script>
  function getMsSinceMidnight(d) {
        var hms = d
        var a = hms.split(':')
        var minutes = (+a[0]) * 60 + (+a[1]);
     return minutes.toString()
    }  
  </script>
  
  
  
  <script>
  // draw leaflet
    var map = L.map('mapid').setView([-35.28, 149.128], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);
    // update on click
    map.on('click', function(e) {
      updater(e);
    });
    //put marker + update coordinates
    var layerGroup = L.layerGroup().addTo(map);
    function updater(e) {
      var x = e.layerPoint.x;
      var y = e.layerPoint.y;
      document.getElementById("lat").innerHTML = x;
      document.getElementById("lon").innerHTML = y;
      var pointXY = L.point(x, y);
      var pointlatlng = map.layerPointToLatLng(pointXY); 
      layerGroup.clearLayers();
      var marker = L.marker([pointlatlng.lat, pointlatlng.lng]).addTo(layerGroup);
      document.getElementById("lat").value = pointlatlng.lat;
      document.getElementById("lon").value = pointlatlng.lng;
      
      
     // console.log(document.getElementById("dtp").value);
      //console.log(getMsSinceMidnight(document.getElementById("dtp").value));
      
    }
  </script>
  

</body>

</html>